const{ArrayBuffer:e,Atomics:t,Promise:r}=globalThis,{isArray:s}=Array,{create:n,getPrototypeOf:a,values:o}=Object,c=a(Int32Array),i=n(t),l=({currentTarget:e,type:t,origin:r,lastEventId:s,source:n,ports:a},o)=>e.dispatchEvent(new MessageEvent(t,{data:o,origin:r,lastEventId:s,source:n,ports:a})),p=()=>r.withResolvers();let f=0;const u=new Map,d=(e,t)=>class extends e{constructor(e,...r){super(e,...r),e instanceof t&&u.set(this,[f++,0,p()])}},w=new WeakSet,y=e=>(w.add(e),e),g=(e,t)=>{const{data:r}=e,n=s(r)&&(r.at(0)===t||0===r.at(1)&&!t);return n&&(e.stopImmediatePropagation(),e.preventDefault()),n},h=e=>null!==e&&"object"==typeof e&&!w.has(e),v=new WeakMap,E=(t,r,s)=>{if(u.has(t))r.set(t,u.get(t)[0]);else if(!(t instanceof c||t instanceof e))for(const e of o(t))h(e)&&!s.has(e)&&(s.add(e),E(e,r,s))},A=(...e)=>({value:new r((t=>{let r=new Worker("data:application/javascript,onmessage%3De%3D%3EpostMessage(!Atomics.wait(...e.data))");r.onmessage=()=>t("ok"),r.postMessage(e)}))}),m=(e,t)=>{const r=u.get(e),[s,n,{promise:a}]=r;return r[1]=t,[s,a]};let{BigInt64Array:k,Int32Array:T,SharedArrayBuffer:b,addEventListener:M,postMessage:x}=globalThis,I=!0,S=e=>e,P=!1;const $=p();try{new b(4),i.waitAsync||(i.waitAsync=A),$.resolve()}catch(t){const r=x,s=M,n=[];let a="",o="";b=class extends e{},k=d(k,b),T=d(T,b),S=y,P=!0,i.notify=(e,t)=>{const[s]=(e=>v.get(e))(e);return r([a,1,e,s,t]),0},i.waitAsync=(...e)=>{const[t,r]=m(...e);return{value:r}},i.wait=(e,t,...r)=>{const[s]=m(e,t,...r),n=new XMLHttpRequest;n.responseType="json",n.open("POST",`${o}?sabayon`,!1),n.setRequestHeader("Content-Type","application/json"),n.send(`["${a}",${s},${t}]`);const{response:c}=n;u.delete(e);for(let t=0;t<c.length;t++)e[t]=c[t];return"ok"},s("message",(e=>{if(g(e,a)){const[t,r,...s]=e.data;switch(r){case 0:a=t,o=s.at(0)?.serviceWorker||"",o||(i.wait=null,$.resolve());break;case 1:((e,t,r)=>{for(const[s,[n,a,{resolve:o}]]of u)if(t===n&&r===a){for(let t=0;t<e.length;t++)s[t]=e[t];u.delete(s),o("ok");break}})(...s);break;case 2:((e,t,r)=>{for(const[r,s]of t)v.set(r,[s,e.currentTarget]);l(e,r)})(e,...s);break;case 3:$.resolve()}}else if(I){const{currentTarget:t,type:r,origin:s,lastEventId:a,source:o,ports:c}=e;n.push([{currentTarget:t,type:r,origin:s,lastEventId:a,source:o,ports:c},e.data])}})),M=(e,...t)=>{if(s(e,...t),n.length)for(const e of n.splice(0))l(...e)},x=(e,...t)=>r(((e,t)=>{const r=new Map;return h(t)&&E(t,r,new Set),r.size?[e,2,r,t]:t})(a,e),...t)}await $.promise,I=!1;const{BYTES_PER_ELEMENT:j}=Int32Array,{BYTES_PER_ELEMENT:B}=Uint16Array,{notify:R}=i,W=new TextDecoder("utf-16"),D=new WeakSet,L=(...e)=>(D.add(e),e);let O="";const U=new Map,_=(e,t,r)=>{const[s]=r,n=t.get(s);if(!n)throw new Error(`Unknown proxy.${s}()`);e(n,r)};let N=0;const q=(e,t)=>new Proxy(t,{get:(t,r)=>t.get(r)||t.set(r,(([e,t,r,s,n,a,o,c,i,l],p)=>(...f)=>{if(""!==O)throw new Error(`ðŸ’€ðŸ”’ - proxy.${p}() deadlock in proxy.${O}()`);const u=N++,d=[];D.has(f.at(-1)||d)&&D.delete(d=f.pop());const w=s(i?f.map(i):f);let y=new t(new r(2*j));return c([e,2,p,u,y,w,n],{transfer:d}),l(y,0).value.then((()=>{const s=y[1];if(!s)return;const n=B*s;return y=new t(new r(n+n%j)),c([e,1,u,y]),l(y,0).value.then((()=>{const e=new Uint16Array(y.buffer),t=o?e.subarray(0,s):e.slice(0,s);return a(W.decode(t))}))}))})(e,r)).get(r),set:(e,t,r)=>!!e.set(t,r)}),{wait:z,waitAsync:C}=i;var H=({interrupt:e,parse:t,stringify:r,transform:s}=JSON)=>{const n=((e,t)=>async(r,[s,n,a,o,c])=>{c&&(O=s);try{const s=await r(...o);if(void 0!==s){const r=e(t?t(s):s);U.set(n,r),a[1]=r.length}}finally{c&&(O=""),a[0]=1,R(a,0)}})(r,s),a=p(),o=new Map;let c="",i=z;if(z&&e){const{handler:t,timeout:r=42}=e;i=(e,s,n)=>{for(;"timed-out"===(n=z(e,s,0,r));)t();return n}}return M("message",(e=>{if(g(e,c)){const[r,l,...p]=e.data;switch(l){case 0:c=r,a.resolve({transfer:L,proxy:q([c,T,b,S,!!z,t,P,x,s,z?(...e)=>({value:{then:t=>t(i(...e))}}):C],o)});break;case 2:o.size?_(n,o,p):setTimeout(_,0,n,o,p);break;case 1:((e,t)=>{const r=U.get(e);U.delete(e);for(let e=new Uint16Array(t.buffer),s=0,{length:n}=r;s<n;s++)e[s]=r.charCodeAt(s);R(t,0)})(...p)}}})),a.promise};export{H as default};
