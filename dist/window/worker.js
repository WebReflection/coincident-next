const e="array",t="function",r="null",n="number",s="object",a="string",o="symbol",c="undefined",l="apply",i="construct",u="defineProperty",f="deleteProperty",p="get",y="getOwnPropertyDescriptor",w="getPrototypeOf",d="has",g="isExtensible",v="ownKeys",h="preventExtensions",E="set",b="setPrototypeOf";var T=Object.freeze({__proto__:null,APPLY:l,CONSTRUCT:i,DEFINE_PROPERTY:u,DELETE_PROPERTY:f,GET:p,GET_OWN_PROPERTY_DESCRIPTOR:y,GET_PROTOTYPE_OF:w,HAS:d,IS_EXTENSIBLE:g,OWN_KEYS:v,PREVENT_EXTENSION:h,SET:E,SET_PROTOTYPE_OF:b});function m(){return this}const O=new FinalizationRegistry((([e,t,r])=>{r&&console.debug(`Held value ${String(t)} not relevant anymore`),e(t)})),P=Object.create(null),{Object:_,Proxy:k,Reflect:S}=globalThis,{isArray:A}=Array,{ownKeys:R}=S,{create:x,hasOwn:M,values:I}=_,j=(r,n)=>n===e?r[0]:n===t?r():n===s?r.$:r,$=(e,t,r,n)=>{const s={type:{value:t}},a=M(e,"valueOf");for(const o of I(T)){let c=n(e[o]||S[o]);if(a&&o===p){const{valueOf:n}=e,{value:s}=c;c={value(e,a,...o){return a===r?n.call(this,j(e,t)):s.call(this,e,a,...o)}}}s[o]=c}return x(e,s)},N=(e,r,n,a=e)=>{if(a===e)switch(typeof e){case s:case t:case c:break;default:a=!1,r===e&&(r=_(e))}const o=new k(r,n),{destruct:l}=n;return l?((e,t,{debug:r,handler:n,return:s,token:a=e}=P)=>{const o=s||new Proxy(e,n||P),c=[o,[t,e,!!r]];return!1!==a&&c.push(a),O.register(...c),o})(e,l,{token:a,return:o}):o},W=t=>n=>{const a=typeof n;return a===s?n?t.get(n)||(A(n)?e:s):r:a},Y=e=>((e=>{O.unregister(e)})(e),e);var D=r=>{const n=new WeakMap,a=Symbol(),o={},c={proxy:o,release:Y,typeOf:W(n),valueOf:e=>e[a]??e.valueOf()};for(const l of R(r)){if(M(c,l))continue;const i=r[l];switch(l){case e:{const e=$(i,l,a,(e=>({value([t],...r){return e.call(this,t,...r)}})));o[l]=(t,...r)=>N(t,[t],e,...r);break}case t:{const e=$(i,l,a,(e=>({value(t,...r){return e.call(this,t(),...r)}})));o[l]=(t,...r)=>{return N(t,(n=t,m.bind(n)),e,...r);var n};break}case s:{const e=$(i,l,a,(e=>({value({$:t},...r){return e.call(this,t,...r)}})));o[l]=(t,...r)=>N(t,{$:t},e,...r);break}default:{const e=$(i,l,a,(e=>({value:e})));o[l]=(t,...r)=>{const s=N(t,t,e,...r);return n.set(s,l),s};break}}}return c};let L=0;const B=new Map,C=new Map,F=e=>C.get(e),{ArrayBuffer:U,Atomics:z,Promise:H}=globalThis,{isArray:G}=Array,{create:K,getPrototypeOf:X,values:q}=Object,J=X(Int32Array),V=K(z),Q=({currentTarget:e,type:t,origin:r,lastEventId:n,source:s,ports:a},o)=>e.dispatchEvent(new MessageEvent(t,{data:o,origin:r,lastEventId:n,source:s,ports:a})),Z=()=>H.withResolvers();let ee=0;const te=new Map,re=(e,t)=>class extends e{constructor(e,...r){super(e,...r),e instanceof t&&te.set(this,[ee++,0,Z()])}},ne=new WeakSet,se=e=>(ne.add(e),e),ae=(e,t)=>{const{data:r}=e,n=G(r)&&(r.at(0)===t||0===r.at(1)&&!t);return n&&(e.stopImmediatePropagation(),e.preventDefault()),n},oe=e=>null!==e&&"object"==typeof e&&!ne.has(e),ce=new WeakMap,le=(e,t,r)=>{if(te.has(e))t.set(e,te.get(e)[0]);else if(!(e instanceof J||e instanceof U))for(const n of q(e))oe(n)&&!r.has(n)&&(r.add(n),le(n,t,r))},ie=(...e)=>({value:new H((t=>{let r=new Worker("data:application/javascript,onmessage%3De%3D%3EpostMessage(!Atomics.wait(...e.data))");r.onmessage=()=>t("ok"),r.postMessage(e)}))}),ue=(e,t)=>{const r=te.get(e),[n,s,{promise:a}]=r;return r[1]=t,[n,a]};let{BigInt64Array:fe,Int32Array:pe,SharedArrayBuffer:ye,addEventListener:we,postMessage:de}=globalThis,ge=!0,ve=e=>e,he=!1;const Ee=Z();try{new ye(4),V.waitAsync||(V.waitAsync=ie),Ee.resolve()}catch(e){const t=de,r=we,n=[];let s="",a="";ye=class extends U{},fe=re(fe,ye),pe=re(pe,ye),ve=se,he=!0,V.notify=(e,r)=>{const[n]=(e=>ce.get(e))(e);return t([s,1,e,n,r]),0},V.waitAsync=(...e)=>{const[t,r]=ue(...e);return{value:r}},V.wait=(e,t,...r)=>{const[n]=ue(e,t,...r),o=new XMLHttpRequest;o.responseType="json",o.open("POST",`${a}?sabayon`,!1),o.setRequestHeader("Content-Type","application/json"),o.send(`["${s}",${n},${t}]`);const{response:c}=o;te.delete(e);for(let t=0;t<c.length;t++)e[t]=c[t];return"ok"},r("message",(e=>{if(ae(e,s)){const[t,r,...n]=e.data;switch(r){case 0:s=t,a=n.at(0)?.serviceWorker||"",a||(V.wait=null,Ee.resolve());break;case 1:((e,t,r)=>{for(const[n,[s,a,{resolve:o}]]of te)if(t===s&&r===a){for(let t=0;t<e.length;t++)n[t]=e[t];te.delete(n),o("ok");break}})(...n);break;case 2:((e,t,r)=>{for(const[r,n]of t)ce.set(r,[n,e.currentTarget]);Q(e,r)})(e,...n);break;case 3:Ee.resolve()}}else if(ge){const{currentTarget:t,type:r,origin:s,lastEventId:a,source:o,ports:c}=e;n.push([{currentTarget:t,type:r,origin:s,lastEventId:a,source:o,ports:c},e.data])}})),we=(e,...t)=>{if(r(e,...t),n.length)for(const e of n.splice(0))Q(...e)},de=(e,...r)=>t(((e,t)=>{const r=new Map;return oe(t)&&le(t,r,new Set),r.size?[e,2,r,t]:t})(s,e),...r)}await Ee.promise,ge=!1;const{BYTES_PER_ELEMENT:be}=Int32Array,{BYTES_PER_ELEMENT:Te}=Uint16Array,{notify:me}=V,Oe=new TextDecoder("utf-16"),Pe=new WeakSet,_e=(...e)=>(Pe.add(e),e);let ke="";const Se=new Map,Ae=(e,t,r)=>{const[n]=r,s=t.get(n);if(!s)throw new Error(`Unknown proxy.${n}()`);e(s,r)};let Re=0;const xe=(e,t)=>new Proxy(t,{get:(t,r)=>t.get(r)||t.set(r,(([e,t,r,n,s,a,o,c,l,i],u)=>(...f)=>{if(""!==ke)throw new Error(`ðŸ’€ðŸ”’ - proxy.${u}() deadlock in proxy.${ke}()`);const p=Re++,y=[];Pe.has(f.at(-1)||y)&&Pe.delete(y=f.pop());const w=n(l?f.map(l):f);let d=new t(new r(2*be));return c([e,2,u,p,d,w,s],{transfer:y}),i(d,0).value.then((()=>{const n=d[1];if(!n)return;const s=Te*n;return d=new t(new r(s+s%be)),c([e,1,p,d]),i(d,0).value.then((()=>{const e=new Uint16Array(d.buffer),t=o?e.subarray(0,n):e.slice(0,n);return a(Oe.decode(t))}))}))})(e,r)).get(r),set:(e,t,r)=>!!e.set(t,r)}),{wait:Me,waitAsync:Ie}=V;var je=({interrupt:e,parse:t,stringify:r,transform:n}=JSON)=>{const s=((e,t)=>async(r,[n,s,a,o,c])=>{c&&(ke=n);try{const n=await r(...o);if(void 0!==n){const r=e(t?t(n):n);Se.set(s,r),a[1]=r.length}}finally{c&&(ke=""),a[0]=1,me(a,0)}})(r,n),a=Z(),o=new Map;let c="",l=Me;if(Me&&e){const{handler:t,timeout:r=42}=e;l=(e,n,s)=>{for(;"timed-out"===(s=Me(e,n,0,r));)t();return s}}return we("message",(e=>{if(ae(e,c)){const[r,i,...u]=e.data;switch(i){case 0:c=r,a.resolve({transfer:_e,proxy:xe([c,pe,ye,ve,!!Me,t,he,de,n,Me?(...e)=>({value:{then:t=>t(l(...e))}}):Ie],o)});break;case 2:o.size?Ae(s,o,u):setTimeout(Ae,0,s,o,u);break;case 1:((e,t)=>{const r=Se.get(e);Se.delete(e);for(let e=new Uint16Array(t.buffer),n=0,{length:s}=r;n<s;n++)e[n]=r.charCodeAt(n);me(t,0)})(...u)}}})),a.promise},$e=Object.fromEntries([e,"bigint","boolean",t,r,n,s,a,o,c].map(((e,t)=>[e,t])));const Ne="destruct",We="valueOf",{[v]:Ye}=Reflect,De=new Map(Ye(Symbol).filter((e=>typeof Symbol[e]===o)).map((e=>[Symbol[e],e]))),Le=e=>De.get(e)||`.${Symbol.keyFor(e)||""}`,{[l]:Be}=Reflect;var Ce=async r=>{const c=await je(r),T=r?.transform||(e=>e),{__main__:m}=c.proxy,O=new Map,P=(e,t)=>{let r=O.get(e)?.deref();return r||O.set(e,new WeakRef(r=t(e))),r},_=([r,c])=>{switch(r){case $e[s]:return null==c?globalThis:typeof c===n?P(c,R.object):c;case $e[e]:return typeof c===n?P(c,R.array):c.map(_);case $e[t]:return typeof c===a?F(parseInt(c)):P(c,R.function);case $e[o]:return(e=>{if(e.startsWith("."))return Symbol.for(e.slice(1));for(const[t,r]of De)if(r===e)return t})(c);default:return c}},k=r=>{const a=x(r);switch(a){case s:{let e=r;if(r===globalThis||null==r)e=null;else if(!(r instanceof J)&&(e=M(T(r)),typeof e===s))for(const t in e)e[t]=k(e[t]);return[$e[s],e]}case e:{let t=M(T(r));return[$e[e],typeof t===n?t:t.map(k)]}case t:{let e=M(T(r));return typeof e===t&&(e=String((e=>{if(!B.has(e)){let t;for(;C.has(t=L++););B.set(e,t),C.set(t,e)}return B.get(e)})(e))),[$e[t],e]}case o:return[$e[o],Le(r)];default:return[$e[a],r]}},S=(...e)=>_(m(...e)),A={[u]:(e,t,r)=>{const{get:n,set:s,value:a}=r;return n&&(r.get=k(n)),s&&(r.set=k(s)),a&&(r.value=k(a)),S(u,e,k(t),r)},[f]:(e,t)=>S(f,e,k(t)),[w]:e=>S(w,e),[p]:(e,t)=>S(p,e,k(t)),[y]:(e,t)=>{const r=S(y,e,k(t));if(r){const{get:e,set:t,value:n}=r;e&&(r.get=_(e)),t&&(r.set=_(t)),n&&(r.value=_(n))}return r},[d]:(e,t)=>S(d,e,k(t)),[g]:e=>S(g,e),[v]:e=>S(v,e),[h]:e=>S(h,e),[E]:(e,t,r)=>S(E,e,k(t),k(r)),[b]:(e,t)=>S(b,e,k(t)),[We]:e=>e,[Ne](e){O.delete(e),m(Ne,e)}},{proxy:R,typeOf:x,valueOf:M}=D({object:A,array:A,function:{...A,[l]:(e,...t)=>S(l,e,...t.map(k)),[i]:(e,...t)=>S(i,e,...t.map(k))}}),I=R.object(null);return c.proxy.__worker__=(e,t,...r)=>{const s=parseInt(t);switch(e){case l:return Be(F(s),...r.map(_));case Ne:(e=>{const[t,r]=typeof e===n?[C,B]:[B,C],s=t.has(e);s&&(r.delete(t.get(e)),t.delete(e))})(s)}},{...c,window:I,isWindowProxy:e=>M(e)!==e}};export{Ce as default};
